<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Chat</title>
    <!-- Script de Tema -->
    <script>
        (function () {
            const theme = localStorage.getItem('app-theme') || 'purple';
            const mode = localStorage.getItem('app-mode') || 'dark';
            document.documentElement.setAttribute('data-theme', theme);
            document.documentElement.setAttribute('data-mode', mode);
        })();
    </script>
    <!-- Estilos -->
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <link href="./css/tailwind.css" rel="stylesheet">
    <link href="./css/global.css" rel="stylesheet">
    <link href="./css/components.css" rel="stylesheet">
    <link href="./css/pages.css" rel="stylesheet">
    <!-- Scripts de Librerías -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
</head>

<body class="chat-layout">

    <div class="top-bar">
        <button onclick="window.history.back()" class="header-back-btn">←</button>
        <div class="chat-header-info">
            <img id="chat-user-avatar" src="./assets/img/default-avatar.png" class="chat-header-avatar" />
            <span id="chat-user-username" class="header-title">Cargando...</span>
        </div>
        <div class="top-right"></div>
    </div>

    <div id="sticky-date-header" class="sticky-date-header"><span></span></div>

    <main id="chat-messages-container" class="chat-messages"></main>

    <div id="emoji-sticker-picker" class="picker-container" style="display: none;">
        <div class="picker-tabs">
            <!-- Pestaña Emojis -->
            <button class="picker-tab active" data-tab="emoji-content" title="Emojis">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                    <path fill="currentColor" fill-rule="evenodd"
                        d="M12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10s-4.477 10-10 10m0-4a5.5 5.5 0 0 0 5.478-5H6.522A5.5 5.5 0 0 0 12 18m-3.5-7.5a1.5 1.5 0 1 0 0-3a1.5 1.5 0 0 0 0 3m7 0a1.5 1.5 0 1 0 0-3a1.5 1.5 0 0 0 0 3" />
                </svg>
            </button>
        
            <!-- Pestaña GIPHY -->
            <button class="picker-tab" data-tab="giphy-sticker-content" title="Giphy">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                    <path fill="currentColor"
                        d="M16.62 3H7.37A5.36 5.36 0 0 0 2 8.33v7.33A5.36 5.36 0 0 0 7.37 21h9.25A5.37 5.37 0 0 0 22 15.66V8.33A5.36 5.36 0 0 0 16.62 3m-5.64 9.58a2.76 2.76 0 0 1-.35 1.45a2.44 2.44 0 0 1-1 .93a3 3 0 0 1-1.42.32a3.1 3.1 0 0 1-1.58-.39a2.65 2.65 0 0 1-1.06-1.14A3.8 3.8 0 0 1 5.18 12c0-.473.078-.942.23-1.39a2.9 2.9 0 0 1 .64-1a2.7 2.7 0 0 1 1-.65a3.27 3.27 0 0 1 2.19-.06c.299.1.58.249.83.44a2.4 2.4 0 0 1 .89 1.56H9.58a1.2 1.2 0 0 0-.85-.89a1.6 1.6 0 0 0-.48 0a1.48 1.48 0 0 0-1.45.95a2.7 2.7 0 0 0-.21 1.13a3 3 0 0 0 .2 1.14c.123.287.324.532.58.71c.262.168.569.252.88.24c.269.008.536-.047.78-.16a1.2 1.2 0 0 0 .52-.5a1.4 1.4 0 0 0 .16-.66h-1.4v-1h2.7zm2.47 2.54a.1.1 0 0 1 0 .07h-1.27V8.98h1.27a.1.1 0 0 1 0 .06zm5.34-5.18h-2.77a.07.07 0 0 0 0 .06v1.34a.2.2 0 0 0 0 .06h2.57v1.12h-2.57a.1.1 0 0 0 0 .06v2.5h-1.26V8.82a.07.07 0 0 1 .08-.08h3.95z" />
                </svg>
            </button>
        
            <!-- Pestaña Personalizados -->
            <button class="picker-tab" data-tab="custom-sticker-content" title="Mis Stickers">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 256 256">
                    <path fill="currentColor"
                        d="M168 32H88a56.06 56.06 0 0 0-56 56v80a56.06 56.06 0 0 0 56 56h48a8 8 0 0 0 2.53-.41c26.23-8.75 76.31-58.83 85.06-85.06A8 8 0 0 0 224 136V88a56.06 56.06 0 0 0-56-56m-32 175.42V176a40 40 0 0 1 40-40h31.42c-9.26 21.55-49.87 62.16-71.42 71.42" />
                </svg>
            </button>
        </div>
        <div class="picker-content">
            <div id="emoji-content" class="picker-content-panel active"></div>
            <div id="giphy-sticker-content" class="picker-content-panel">
                <div class="sticker-search-bar">
                    <input type="text" id="sticker-search-input" placeholder="Buscar stickers en GIPHY...">
                </div>
                <div id="giphy-sticker-grid" class="sticker-grid"></div>
            </div>
            <div id="custom-sticker-content" class="picker-content-panel">
                <div id="custom-sticker-loader" style="display: none;">
                    <p class="search-placeholder">Subiendo...</p>
                </div>
                <div id="custom-sticker-grid" class="sticker-grid"></div>
                
            </div>
        </div>
    </div>

    <div id="reply-context-bar" class="reply-context">
        <div class="reply-preview">
            <span id="reply-to-user" class="reply-to-user"></span>
            <span id="reply-snippet" class="reply-snippet"></span>
        </div>
        <button id="cancel-reply-btn" class="cancel-reply-btn">&times;</button>
    </div>

    <form id="chat-form" class="comment-input-bar">
        <div class="input-row">
            <button type="button" id="emoji-btn" class="emoji-toggle-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                    <path fill="currentColor" fill-rule="evenodd"
                        d="M12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10s-4.477 10-10 10m0-4a5.5 5.5 0 0 0 5.478-5H6.522A5.5 5.5 0 0 0 12 18m-3.5-7.5a1.5 1.5 0 1 0 0-3a1.5 1.5 0 0 0 0 3m7 0a1.5 1.5 0 1 0 0-3a1.5 1.5 0 0 0 0 3" />
                </svg>
            </button>
            <textarea id="chat-message-input" placeholder="Escribe un mensaje..." rows="1"></textarea>
            <button type="submit" id="send-chat-btn" class="comment-send-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                    <path fill="currentColor" fill-rule="evenodd"
                        d="M3.402 6.673c-.26-2.334 2.143-4.048 4.266-3.042l11.944 5.658c2.288 1.083 2.288 4.339 0 5.422L7.668 20.37c-2.123 1.006-4.525-.708-4.266-3.042L3.882 13H12a1 1 0 1 0 0-2H3.883z"
                        clip-rule="evenodd" />
                </svg>
            </button>
        </div>
    </form>

    <div id="sticker-creator-modal" class="sticker-creator-overlay" style="display: none;">
        <div class="sticker-creator-content">
            <div class="sticker-creator-header">
                <h3>Crear Sticker</h3>
                <button id="close-sticker-creator-btn">&times;</button>
            </div>
            <div class="sticker-creator-body">
                <div id="sticker-editor-view-image" style="display: none;">
                    <div class="sticker-crop-container">
                        <img id="sticker-source-image" src="">
                    </div>
                </div>
                <div id="sticker-editor-view-video" style="display: none;">
                    <video id="sticker-source-video" controls style="width: 100%; max-height: 300px;"></video>
                    <div id="trimmer-container" class="trimmer">
                        <div class="trimmer-timeline">
                            <div id="trimmer-selection" class="trimmer-selection"></div>
                            <div id="trimmer-playhead" class="trimmer-playhead"></div>
                        </div>
                        <div id="trimmer-start-handle" class="trimmer-handle"></div>
                        <div id="trimmer-end-handle" class="trimmer-handle"></div>
                    </div>
                    <div class="audio-toggle-container">
                        <input type="checkbox" id="sticker-audio-toggle" checked>
                        <label for="sticker-audio-toggle">Incluir audio</label>
                    </div>
                </div>
                <div id="ffmpeg-loader-view" style="display: none;">
                    <p class="search-placeholder">Inicializando editor de video...</p>
                    <p id="ffmpeg-log"></p>
                </div>
            </div>
            <div class="sticker-creator-footer">
                <button id="cancel-sticker-btn" class="modal-btn secondary">Cancelar</button>
                <button id="save-sticker-btn" class="modal-btn primary">Crear y Enviar</button>
            </div>
        </div>
    </div>

<!-- ==================================================== -->
<!-- === NUEVO: MENÚ CONTEXTUAL PARA MENSAJES       === -->
<!-- ==================================================== -->
<div id="context-menu-overlay" class="context-overlay"></div>

<div id="context-menu" class="context-menu">
    <div id="context-menu-options" class="context-menu-options">
        <button id="reply-from-menu-btn" class="context-menu-button">
            <span class="context-menu-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
                    <path
                        d="M6.40625 1.08752C6.76562 1.24689 7 1.60627 7 2.00002V4.00002H10.5C13.5375 4.00002 16 6.46252 16 9.50002C16 13.0406 13.4531 14.6219 12.8687 14.9406C12.7906 14.9844 12.7031 15 12.6156 15C12.275 15 12 14.7219 12 14.3844C12 14.15 12.1344 13.9344 12.3062 13.775C12.6 13.5 13 12.95 13 12.0031C13 10.3469 11.6562 9.00314 10 9.00314H7V11.0031C7 11.3969 6.76875 11.7563 6.40625 11.9156C6.04375 12.075 5.625 12.0094 5.33125 11.7469L0.33125 7.24689C0.121875 7.05314 0 6.78439 0 6.50002C0 6.21564 0.121875 5.94689 0.33125 5.75627L5.33125 1.25627C5.625 0.990644 6.04688 0.925019 6.40625 1.08752Z"
                        fill="currentColor" />
                </svg>
            </span>
            <span class="context-menu-text">Responder</span>
        </button>
        <button id="copy-btn" class="context-menu-button">
            <span class="context-menu-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 18 18" fill="none">
                    <path
                        d="M14.3438 16.875H6.46875C5.79742 16.875 5.15359 16.6083 4.67889 16.1336C4.20418 15.6589 3.9375 15.0151 3.9375 14.3438V6.46875C3.9375 5.79742 4.20418 5.15359 4.67889 4.67889C5.15359 4.20418 5.79742 3.9375 6.46875 3.9375H14.3438C15.0151 3.9375 15.6589 4.20418 16.1336 4.67889C16.6083 5.15359 16.875 5.79742 16.875 6.46875V14.3438C16.875 15.0151 16.6083 15.6589 16.1336 16.1336C15.6589 16.6083 15.0151 16.875 14.3438 16.875Z"
                        fill="currentColor" />
                    <path
                        d="M5.625 2.8125H13.9177C13.7426 2.31934 13.4193 1.89242 12.9921 1.59029C12.5648 1.28816 12.0545 1.12563 11.5312 1.125H3.65625C2.98492 1.125 2.34109 1.39168 1.86639 1.86639C1.39168 2.34109 1.125 2.98492 1.125 3.65625V11.5312C1.12563 12.0545 1.28816 12.5648 1.59029 12.9921C1.89242 13.4193 2.31934 13.7426 2.8125 13.9177V5.625C2.8125 4.87908 3.10882 4.16371 3.63626 3.63626C4.16371 3.10882 4.87908 2.8125 5.625 2.8125Z"
                        fill="currentColor" />
                </svg>
            </span>
            <span class="context-menu-text">Copiar</span>
        </button>
        <button id="delete-from-menu-btn" class="context-menu-button destructive" style="display: none;">
            <span class="context-menu-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="18" viewBox="0 0 14 18" fill="none">
                    <path
                        d="M1 16C1 17.1 1.9 18 3 18H11C12.1 18 13 17.1 13 16V6C13 4.9 12.1 4 11 4H3C1.9 4 1 4.9 1 6V16ZM13 1H10.5L9.79 0.29C9.61 0.11 9.35 0 9.09 0H4.91C4.65 0 4.39 0.11 4.21 0.29L3.5 1H1C0.45 1 0 1.45 0 2C0 2.55 0.45 3 1 3H13C13.55 3 14 2.55 14 2C14 1.45 13.55 1 13 1Z"
                        fill="#D33F49" />
                </svg>
            </span>
            <span class="context-menu-text">Eliminar</span>
        </button>
    </div>
</div>
<!-- ==================================================== -->

<!-- ============================================= -->
<!-- === MODAL DE CONFIRMACIÓN DE BORRADO === -->
<!-- ============================================= -->
<div id="delete-confirm-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <h4>Confirmar Eliminación</h4>
        <p>¿Estás seguro de que quieres eliminar este mensaje? Esta acción no se puede deshacer.</p>
        <div class="modal-actions">
            <button id="cancel-delete-btn" class="modal-btn secondary">Cancelar</button>
            <button id="confirm-delete-btn" class="modal-btn danger">Eliminar</button>
        </div>
    </div>
</div>
<!-- ============================================= -->

    <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>
    <script src="./js/app.js" type="module"></script>
</body>

</html>