<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Chat</title>
    <!-- ... (tus scripts de tema y CSS links) ... -->
    <!-- ========================================================= -->
    <!-- === INICIO DEL SCRIPT ANTI-PARPADEO DE TEMA === -->
    <!-- ========================================================= -->
    <script>
        (function () {
            const theme = localStorage.getItem('app-theme') || 'purple';
            const mode = localStorage.getItem('app-mode') || 'dark';
            document.documentElement.setAttribute('data-theme', theme);
            document.documentElement.setAttribute('data-mode', mode);
        })();
    </script>
    <!-- ========================================================= -->
    <!-- === FIN DEL SCRIPT === -->
    <!-- ========================================================= -->
    <!-- Plyr.io CSS (para los estilos del reproductor) -->
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    <!-- Hojas de Estilo Estandarizadas -->
    <link href="./css/tailwind.css" rel="stylesheet">
    <link href="./css/global.css" rel="stylesheet">
    <link href="./css/components.css" rel="stylesheet">
    <link href="./css/pages.css" rel="stylesheet">


    <!-- ¬°A√ëADE ESTOS DOS! -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
</head>

<body class="chat-layout">

    <div class="top-bar">
        <button onclick="window.history.back()" class="header-back-btn">‚Üê</button>
        <div class="chat-header-info">
            <img id="chat-user-avatar" src="./assets/img/default-avatar.png" class="chat-header-avatar" />
            <span id="chat-user-username" class="header-title">Cargando...</span>
        </div>
        <div class="top-right"></div>
    </div>

    <!-- NUEVO: Header de Fecha Anclado (Sticky) -->
    <div id="sticky-date-header" class="sticky-date-header">
        <span></span>
    </div>
    
    <!-- Contenido Principal (donde se muestra la lista) -->
    <main id="chat-messages-container" class="chat-messages"></main>
    <!-- ========================================================== -->
    <!-- === ¬°NUEVO CONTENEDOR PARA EL SELECTOR DE EMOJIS/STICKERS! === -->
    <!-- ========================================================== -->
    <div id="emoji-sticker-picker" class="picker-container">
        <div class="picker-tabs">
            <button class="picker-tab active" data-tab="emoji-content">üòÄ</button>
            <button class="picker-tab" data-tab="giphy-sticker-content">‚ú®</button>
            <button class="picker-tab" data-tab="custom-sticker-content">üë§</button> <!-- ¬°NUEVA PESTA√ëA! -->
        </div>
        <div class="picker-content">
            <div id="emoji-content" class="picker-content-panel active"></div>
        
            <!-- ¬°CONTENIDO ACTUALIZADO PARA LOS STICKERS! -->
            <div id="giphy-sticker-content" class="picker-content-panel"> <!-- ID CAMBIADO -->
            
                <!-- ========================================================== -->
                <!-- === ¬°BARRA DE B√öSQUEDA MEJORADA! === -->
                <!-- ========================================================== -->
                <div class="sticker-search-bar">
                    <div class="search-bar-container">
                        <!-- Icono de Lupa -->
                        <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"><path fill="currentColor" d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5A6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5S14 7.01 14 9.5S11.99 14 9.5 14z"/></svg>
                        <!-- Campo de texto -->
                        <input type="text" id="sticker-search-input" placeholder="Buscar stickers...">
                        <!-- Bot√≥n para limpiar (oculto por defecto) -->
                        <button id="clear-sticker-search-btn" class="clear-btn" style="display: none;">&times;</button>
                    </div>
                </div>
                <!-- ========================================================== -->

                <div id="sticker-results-grid" class="sticker-grid">
                    <!-- El JS llenar√° esta cuadr√≠cula -->
                </div>
            </div>

            <!-- ¬°NUEVO PANEL PARA STICKERS PERSONALIZADOS! -->
            <!-- ¬°PANEL DE STICKERS PERSONALIZADOS ACTUALIZADO! -->
            <div id="custom-sticker-content" class="picker-content-panel">
                
                <!-- Contenedor para el mensaje de carga (oculto por defecto) -->
                <div id="custom-sticker-loader" style="display: none;">
                    <p class="search-placeholder">Subiendo GIF...</p>
                </div>

                <!-- La cuadr√≠cula donde siempre se renderizar√°n los stickers -->
                <div id="custom-sticker-grid" class="sticker-grid">
                    <!-- El JS llenar√° esto -->
                </div>
                
                <button id="create-sticker-btn" class="create-sticker-button">+</button>
            </div>
        </div>
    </div>
    <!-- ========================================================== -->
    <!-- NUEVO: Barra de Contexto de Respuesta (oculta por defecto) -->
    <div id="reply-context-bar" class="reply-context">
        <div class="reply-preview">
            <span id="reply-to-user" class="reply-to-user"></span>
            <span id="reply-snippet" class="reply-snippet"></span>
        </div>
        <button id="cancel-reply-btn" class="cancel-reply-btn">&times;</button>
    </div>

    
    <!-- Barra de input (MODIFICADA) -->
    <form id="chat-form" class="comment-input-bar">
        <div class="input-row">
            <!-- ¬°NUEVO BOT√ìN DE EMOJI! -->
            <button type="button" id="emoji-btn" class="emoji-toggle-btn">
                <!-- El JS cambiar√° este icono -->
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                    <path fill="currentColor"
                        d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10s10-4.486 10-10S17.514 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8s8 3.589 8 8s-3.589 8-8 8z" />
                    <path fill="currentColor"
                        d="M15.5 8C14.672 8 14 8.672 14 9.5s.672 1.5 1.5 1.5s1.5-.672 1.5-1.5S16.328 8 15.5 8zm-7 0C7.672 8 7 8.672 7 9.5S7.672 11 8.5 11S10 10.328 10 9.5S9.328 8 8.5 8z" />
                    <path fill="currentColor"
                        d="M12 14c-2.336 0-4.46.883-6 2.225V17c0 .552.447 1 1 1h10c.553 0 1-.448 1-1v-.775c-1.54-1.342-3.664-2.225-6-2.225z" />
                </svg>
            </button>
            <textarea id="chat-message-input" placeholder="Escribe un mensaje..." rows="1"></textarea>
            <button type="submit" id="send-chat-btn" class="comment-send-btn">
                <!-- Icono de enviar -->
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                    <path fill="currentColor" fill-rule="evenodd"
                        d="M3.402 6.673c-.26-2.334 2.143-4.048 4.266-3.042l11.944 5.658c2.288 1.083 2.288 4.339 0 5.422L7.668 20.37c-2.123 1.006-4.525-.708-4.266-3.042L3.882 13H12a1 1 0 1 0 0-2H3.883z"
                        clip-rule="evenodd" />
                </svg>
            </button>
        </div>
    </form>

    <!-- ========================================================== -->
    <!-- === ¬°NUEVO MODAL PARA EL EDITOR DE STICKERS! === -->
    <!-- ========================================================== -->
    <div id="sticker-creator-modal" class="sticker-creator-overlay" style="display: none;">
        <div class="sticker-creator-content">
            <div class="sticker-creator-header">
                <h3>Crear Sticker</h3>
                <button id="close-sticker-creator-btn">&times;</button>
            </div>
            <div class="sticker-creator-body">
                <!-- Vista de Edici√≥n (para recorte) -->
                <div id="sticker-editor-view">
                    <div class="sticker-crop-container">
                        <img id="sticker-source-image" src="">
                    </div>
                </div>
            </div>
            <div class="sticker-creator-footer">
                <button id="cancel-sticker-btn" class="modal-btn secondary">Cancelar</button>
                <button id="save-sticker-btn" class="modal-btn primary">Crear y Enviar</button>
            </div>
        </div>
    </div>

    <!-- Librer√≠a de Socket.IO para el cliente -->
    <script src="./js/app.js" type="module"></script>


    <!-- ==================================================== -->
    <!-- === NUEVO: MEN√ö CONTEXTUAL PARA MENSAJES       === -->
    <!-- ==================================================== -->
    <div id="context-menu-overlay" class="context-overlay"></div>
    
    <div id="context-menu" class="context-menu">
        <div id="context-menu-options" class="context-menu-options">
            <button id="reply-from-menu-btn" class="context-menu-button">
                <span class="context-menu-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
                        <path d="M6.40625 1.08752C6.76562 1.24689 7 1.60627 7 2.00002V4.00002H10.5C13.5375 4.00002 16 6.46252 16 9.50002C16 13.0406 13.4531 14.6219 12.8687 14.9406C12.7906 14.9844 12.7031 15 12.6156 15C12.275 15 12 14.7219 12 14.3844C12 14.15 12.1344 13.9344 12.3062 13.775C12.6 13.5 13 12.95 13 12.0031C13 10.3469 11.6562 9.00314 10 9.00314H7V11.0031C7 11.3969 6.76875 11.7563 6.40625 11.9156C6.04375 12.075 5.625 12.0094 5.33125 11.7469L0.33125 7.24689C0.121875 7.05314 0 6.78439 0 6.50002C0 6.21564 0.121875 5.94689 0.33125 5.75627L5.33125 1.25627C5.625 0.990644 6.04688 0.925019 6.40625 1.08752Z" fill="currentColor"/>
                    </svg>
                </span>
                <span class="context-menu-text">Responder</span>
            </button>
            <button id="copy-btn" class="context-menu-button">
                <span class="context-menu-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 18 18" fill="none">
                        <path
                            d="M14.3438 16.875H6.46875C5.79742 16.875 5.15359 16.6083 4.67889 16.1336C4.20418 15.6589 3.9375 15.0151 3.9375 14.3438V6.46875C3.9375 5.79742 4.20418 5.15359 4.67889 4.67889C5.15359 4.20418 5.79742 3.9375 6.46875 3.9375H14.3438C15.0151 3.9375 15.6589 4.20418 16.1336 4.67889C16.6083 5.15359 16.875 5.79742 16.875 6.46875V14.3438C16.875 15.0151 16.6083 15.6589 16.1336 16.1336C15.6589 16.6083 15.0151 16.875 14.3438 16.875Z"
                            fill="currentColor" />
                        <path
                            d="M5.625 2.8125H13.9177C13.7426 2.31934 13.4193 1.89242 12.9921 1.59029C12.5648 1.28816 12.0545 1.12563 11.5312 1.125H3.65625C2.98492 1.125 2.34109 1.39168 1.86639 1.86639C1.39168 2.34109 1.125 2.98492 1.125 3.65625V11.5312C1.12563 12.0545 1.28816 12.5648 1.59029 12.9921C1.89242 13.4193 2.31934 13.7426 2.8125 13.9177V5.625C2.8125 4.87908 3.10882 4.16371 3.63626 3.63626C4.16371 3.10882 4.87908 2.8125 5.625 2.8125Z"
                            fill="currentColor" />
                    </svg>
                </span>
                <span class="context-menu-text">Copiar</span>
            </button>
            <button id="delete-from-menu-btn" class="context-menu-button destructive" style="display: none;">
                <span class="context-menu-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="18" viewBox="0 0 14 18" fill="none">
                        <path
                            d="M1 16C1 17.1 1.9 18 3 18H11C12.1 18 13 17.1 13 16V6C13 4.9 12.1 4 11 4H3C1.9 4 1 4.9 1 6V16ZM13 1H10.5L9.79 0.29C9.61 0.11 9.35 0 9.09 0H4.91C4.65 0 4.39 0.11 4.21 0.29L3.5 1H1C0.45 1 0 1.45 0 2C0 2.55 0.45 3 1 3H13C13.55 3 14 2.55 14 2C14 1.45 13.55 1 13 1Z"
                            fill="#D33F49" />
                    </svg>
                </span>
                <span class="context-menu-text">Eliminar</span>
            </button>
        </div>
    </div>
    <!-- ==================================================== -->

    <!-- ============================================= -->
    <!-- === MODAL DE CONFIRMACI√ìN DE BORRADO === -->
    <!-- ============================================= -->
    <div id="delete-confirm-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h4>Confirmar Eliminaci√≥n</h4>
            <p>¬øEst√°s seguro de que quieres eliminar este mensaje? Esta acci√≥n no se puede deshacer.</p>
            <div class="modal-actions">
                <button id="cancel-delete-btn" class="modal-btn secondary">Cancelar</button>
                <button id="confirm-delete-btn" class="modal-btn danger">Eliminar</button>
            </div>
        </div>
    </div>
    <!-- ============================================= -->
    
    <!-- ¬°A√ëADE ESTE SCRIPT DE LA LIBRER√çA DE EMOJIS! -->
    <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>
    <script src="./js/app.js" type="module"></script>
</body>

</html>